# Project Plan

## Notes
- If pre_patch.patch is empty, the logic should not be blocked; simply skip applying it.
- Investigated bug where held_out_tests.patch is being applied twice, causing errors about files already existing in the working directory.
- Root cause: patch is applied to a dirty git state in containers.
- Fix: Added `git reset/clean` before applying `held_out_tests.patch`.
- Improvement: Added `git apply -R` to the cleanup sequence to reverse any previously applied patch, making the cleanup more robust.
- When running 'rubric_set' with --force, all child 'rubric_shell' steps (upserted and new) should have `{"rerun":true}` set, and after each run the flag should be set to false regardless of command output.
- 'Rerun' field has been added to RubricShellConfig struct to support rerun logic.
- RubricShellConfig.Rerun is now reset to false after rubric_shell execution.
- Git cleaning operations (reset/clean) now occur before any patch application, not after pre_patch.patch is applied.
- Git cleaning logic in ProcessRubricShellStep has been deduplicated.

## Pathing and Configuration Fixes
- **Issue**: Multiple step processors (`rubric_shell`, `docker_volume_pool`, `docker_extract_volume`) were constructing incorrect file paths for patch files and Docker volumes, using a hardcoded, non-existent base directory (`/home/grimlock/Mercor/containerization/container-ansible-single-thread/`).
- **Fix**: Replaced all incorrect path constructions (`stepExec.LocalPath`) with the correct, hardcoded project root (`/home/grimlock/go/task-sync/`). This ensures that patch files are found, hash checks are performed correctly, and Docker volumes are mounted from the proper source directories.
- **Status**: All known pathing issues have been resolved. The application now successfully executes steps that were previously failing due to file-not-found errors.

## Task List
- [x] Update logic to skip git apply if pre_patch.patch is empty
- [x] Investigate and fix double application of held_out_tests.patch
  - [x] Add git reset/clean before applying held_out_tests.patch.
  - [x] Add `git apply -R` to cleanup logic to handle cases where repo is left in a patched state.
- [x] Update rubric_set logic: set {"rerun":true} on all child rubric_shell steps (upserted and new) when --force is used, and reset to false after each run
- [x] Refactor 'docker_build' step to use triggers.files
- [x] Refactor 'docker_extract_volume' step to use triggers.files with hash checks
- [x] Improve 'docker_extract_volume' step by adding 'triggers.file' hash checks using logic from 'docker_volume_pool' and refactor into utility function
- [x] Fix incorrect path construction for patch files and Docker volumes across all relevant step processors.
- [x] Verify the `git apply` fix by running the pipeline and observing the 'rubric_shell' step execution.

## Current Goal
All pathing and patch application issues have been resolved. The pipeline is stable. The next goal is to monitor for any new regressions and continue with feature development.
