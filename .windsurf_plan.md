# Project Plan for Task-Sync
## Force/Rerun Flag Auto-Reset Policy (2025-08-28)

- __Objective__: Ensure any transient force/rerun flags are reset to false after a successful step run so they do not cause unintended forced re-executions.
- __Implementation__:
  - `internal/process_docker_volume_pool.go/ProcessDockerVolumePoolStep`: after a successful force-triggered run, executes a DB update to set `steps.settings.docker_volume_pool.force=false`.
  - `internal/process_model_task_check.go/ProcessModelTaskCheckStep`: sets `config.Force=false` before persisting updated settings/hashes to clear transient force.
  - `internal/steps.go/ProcessDockerExtractVolumeStep`: after success, resets `steps.settings.docker_extract_volume.force=false` alongside existing `golden`/`original` resets.
  - `internal/process_rubric_shell.go/ProcessRubricShellStep`: already resets `rubric_shell.rerun=false` when persisting `hash_last_run`.
- __Notes__: Resets occur only after successful execution. Failures leave flags unchanged for easier retry/debug.
- __Verification__: Build passes; manual runs confirm flags are flipped back to false post-success.


## Objective
Refactor rubric_set and rubric_shell steps to ensure one rubric_shell per criterion, handling all solution patches internally, and storing aggregated results.

## Steps Completed
- Added LocalPath and Results fields to Step and RubricShellConfig models.
- Refactored process_rubric_set.go to create one rubric_shell step per criterion with Assignments.
- Refactored process_rubric_shell.go to iterate over assignments, run tests, and store results.
- Fixed lint errors related to undefined fields and unused imports.

## Next Steps
- Run build and tests to verify changes.
- Test the rubric logic with sample data to ensure consolidation works.
- Address any remaining issues if found.

## Notes
- If pre_patch.patch is empty, the logic should not be blocked; simply skip applying it.
- Investigated bug where held_out_tests.patch is being applied twice, causing errors about files already existing in the working directory.
- Root cause: patch is applied to a dirty git state in containers.
- Fix: Added `git reset/clean` before applying `held_out_tests.patch`.
- Improvement: Added `git apply -R` to the cleanup sequence to reverse any previously applied patch, making the cleanup more robust.
- When running 'rubric_set' with --force, all child 'rubric_shell' steps (upserted and new) should have `{"rerun":true}` set, and after each run the flag should be set to false regardless of command output.
- 'Rerun' field has been added to RubricShellConfig struct to support rerun logic.
- RubricShellConfig.Rerun is now reset to false after rubric_shell execution.
- Git cleaning operations (reset/clean) now occur before any patch application, not after pre_patch.patch is applied.
- Git cleaning logic in ProcessRubricShellStep has been deduplicated.

## Pathing and Configuration Fixes
- **Issue**: Multiple step processors (`rubric_shell`, `docker_volume_pool`, `docker_extract_volume`) were constructing incorrect file paths for patch files and Docker volumes, using a hardcoded, non-existent base directory (`/home/grimlock/Mercor/containerization/container-ansible-single-thread/`).
- **Fix**: Replaced all incorrect path constructions (`stepExec.LocalPath`) with the correct, hardcoded project root (`/home/grimlock/go/task-sync/`). This ensures that patch files are found, hash checks are performed correctly, and Docker volumes are mounted from the proper source directories. (This is wrong fix that needs to be reverted, the correct approach is using the task.settings.local_path as the base path for files)
- **Status**: All known pathing issues have been resolved. The application now successfully executes steps that were previously failing due to file-not-found errors.

## Task List
- [x] Update logic to skip git apply if pre_patch.patch is empty
- [x] Investigate and fix double application of held_out_tests.patch
  - [x] Add git reset/clean before applying held_out_tests.patch.
  - [x] Add `git apply -R` to cleanup logic to handle cases where repo is left in a patched state.
- [x] Update rubric_set logic: set {"rerun":true} on all child rubric_shell steps (upserted and new) when --force is used, and reset to false after each run
- [x] Refactor 'docker_build' step to use triggers.files
- [x] Refactor 'docker_extract_volume' step to use triggers.files with hash checks
- [x] Improve 'docker_extract_volume' step by adding 'triggers.file' hash checks using logic from 'docker_volume_pool' and refactor into utility function
- [x] Fix incorrect path construction for patch files and Docker volumes across all relevant step processors.
- [x] Verify the `git apply` fix by running the pipeline and observing the 'rubric_shell' step execution.
- [x] Fix Rubric Shell Step Duplication: [DONE] (Completed on 2025-07-24)
- [x] Fix rubric shell output reporting to capture and store output correctly with emoji display
- [x] Fix rerun logic for rubric_shell steps: Enhanced runTestSequence to properly handle rerun=true flag with more aggressive git cleanup
- [x] Migrate rubric_shell results storage: Removed duplicate storage in settings.results and now only use the dedicated steps.results column
- [x] Create cleanup command for legacy data: Added 'cleanup legacy-results' command to remove old results fields from step settings
- [x] Database cleanup completed: Successfully cleaned 17 steps that had legacy results fields in their settings

## Recent Achievements (2025-08-01)

### Rubric Shell Rerun Logic Fix
- **Problem**: The `rerun: true` flag was only bypassing hash-based skip logic but wasn't being passed to `runTestSequence`, causing incomplete forced reruns.
- **Solution**: 
  - Modified `runTestSequence` to accept a `rerun` boolean parameter
  - Added enhanced git cleanup when `rerun=true`: `git stash clear`, removal of `.orig` and `.rej` files
  - Added detailed logging to distinguish normal vs rerun cleanup
  - This ensures truly clean environment for forced reruns

### Results Storage Migration
- **Problem**: Results were redundantly stored in both `steps.settings.rubric_shell.results` and `steps.results` column
- **Solution**:
  - Removed `Results` field from `RubricShellConfig` struct
  - Updated `ProcessRubricShellStep` to store results only in dedicated `steps.results` column
  - Updated task report command to read from `steps.results` exclusively
  - Added temporary cleanup logic to remove legacy results from settings
  - Created comprehensive cleanup command for database-wide cleanup
- **Benefits**: Cleaner separation of config and results, better performance, consistency across step types

### Database Cleanup
- Created `cleanup legacy-results` command that successfully cleaned 17 steps
- All legacy `results` fields have been removed from step settings
- Step processing now runs cleanly without cleanup messages
- Report functionality verified to work correctly with new storage format

## Recent Changes (2025-08-14)

- __model_task_check size threshold__: When generating the model prompt file, if inlining `held_out_tests.patch` would make the output exceed 250 KB, we now replace the exact block `<held_out_test_patch>{held_out_test_patch}</held_out_test_patch>` with the message: `held_out_test_patch is provided as an attached file`. Otherwise, the patch content is inlined as before. Implemented in `internal/process_model_task_check.go`.

### Docker Pool Storage Simplification
- Moved container storage from step-level `steps.settings.docker_pool.containers` to task-level `tasks.settings.containers_map` with fixed keys: `original`, `golden`, `solution1..solution4`.
- Moved run parameters to `tasks.settings.docker_run_parameters`.
- Updated `internal/process_docker_pool.go` to always ensure 6 containers and persist to the new task-level fields; step-level `containers`/`parameters` are no longer written.
- Updated consumers to read from task-level:
  - `internal/process_rubric_set_helpers.go/getTaskContainers()` now reads `tasks.settings.containers_map`.
  - `pkg/models/utilities.go/GetAssignedContainersForStep()` prefers `containers_map` with legacy fallback.
- Added `internal/tasks.go/ResetTaskContainers()` to clear `containers_map` and `docker_run_parameters` for a clean slate.

### Rubric Set uses Task Containers
- `rubric_set` now sources container assignments from `tasks.settings.containers_map`.
- Temporary migration cleanup removes legacy per-step fields from `step.settings.rubric_set` when present:
  - `assign_containers`
  - `solution_1.._4` and `solution1..4`
- Added helper `getContainersMap()` in `internal/process_rubric_set_helpers.go`.
- `internal/process_rubric_set.go/ProcessRubricSetStep()` builds `Assignments` mapping `solutionN.patch` to `containers_map.solutionN` for each generated/updated `rubric_shell` step.
- Build verified with `go build ./...`.

### Rubric Shell uses Task Containers Only
- Runtime now derives assignments strictly from `tasks.settings.containers_map` in `internal/process_rubric_shell.go` and ignores any step-level assignments.
- Temporary migration cleanup: when processing a `rubric_shell` step, we remove the following from `steps.settings.rubric_shell` if present and persist sanitized settings:
  - `results` (legacy, now stored in `steps.results` column)
  - `assignments` (legacy per-step overrides)
  - `assingments` (misspelling)
- Logs include `[CLEANUP]` entries when cleanup occurs. Build verified.

### Rubric Shell: Added Golden and Original Execution Paths (2025-08-14)
- **Golden path**: Each `rubric_shell` run now also executes against the `golden` container if `tasks.settings.containers_map.golden` exists.
  - Behavior mirrors solution paths: git cleanup -> optional `pre_patch.patch` -> apply `golden.patch` -> apply `held_out_tests.patch` -> run rubric command.
  - Update (2025-08-14): If copying or applying `golden.patch` fails, we now log a warning and continue to apply `held_out_tests.patch` and run the rubric command anyway. This ensures the golden solution still attempts the held-out test.
  - Note: If `golden.patch` is not present on disk, the run will currently fail copy; we may add a pre-check to skip gracefully.
- **Original path**: Each `rubric_shell` run now also executes against the `original` container if `tasks.settings.containers_map.original` exists.
  - Behavior: git cleanup -> apply `held_out_tests.patch` only -> run rubric command (no solution/golden patch, no pre_patch).
  - Results for these baselines are stored alongside solution results in `steps.results`.
  - Implemented in `internal/process_rubric_shell.go` via new `runOriginalSequence()` and assignment generation from `tasks.settings.containers_map`.

#### Golden Held-out Test Cleanup Hook (2025-08-24)
- Added new task setting: `tasks.settings.held_out_test_clean_up` (string shell command).
- Executed only after the Golden container run in `internal/process_rubric_shell.go`.
- Runs inside the Golden container with `docker exec -w <app_folder> <container> bash -lc "<cmd>"`.
- Does not modify any other Golden cleanup logic; it is an additional hook to clean held-out test changes.

__Update (2025-08-29)__
- For backward compatibility, `TaskSettings` now accepts both `held_out_test_clean_up` and legacy `held_out_test-clean_up` keys during JSON unmarshalling. Implemented via a custom `UnmarshalJSON` in `pkg/models/tasks.go`.
- Rubric Shell Golden/Force behavior: `held_out_tests.patch` application no longer depends on `rsConfig.Files`. We now check for the file at `basePath/held_out_tests.patch` and, if present, always `docker cp` it to `/tmp` and `git apply` it inside the container. Implemented in `internal/process_rubric_shell.go/runTestSequence()` to fix `step golden N --force` not copying the patch.

### Task Report Columns (2025-08-14)
- Updated `internal/report.go` so task report shows six status icons per `rubric_shell` step:
  - `solution1.patch`, `solution2.patch`, `solution3.patch`, `solution4.patch`, `original`, `golden.patch`.
- Default placeholders now render six icons when results are missing.
- Verified with `go run main.go task report 1` that the additional columns appear and reflect results from `steps.results`.

#### Header Labels (2025-08-14)
- Added a header label line printed once per rubric_shell level: `1 2 3 4 O G` to indicate column order.
- Implemented in `internal/report.go` before listing rubric_shell rows.

### Rubric Shell Hash Lock (2025-08-14)
- Enhanced lock to use `task.settings.rubric_set[criterion_id]` vs `step.settings.rubric_shell.hash_last_run`.
- On skip: if hashes match and not forced, execution is skipped.
- On run: persist `hash_last_run` back into `steps.settings.rubric_shell` and reset `rerun` to false.
- Implemented in `internal/process_rubric_shell.go`; added `HashLastRun` to `pkg/models/steps.go` `RubricShellConfig`.

### Rubric Set Criterion Hashes (new)
- Added per-criterion hash storage under `tasks.settings.rubric_set` as a map `criterion_id -> hash`.
- Hash computed from `command`, `counter`, `required`, `rubric`, and `score` using new helper `models.CalcRubricSetCriterionHash()`.
- `internal/process_rubric_set.go` now:
  - Computes current hashes for all criteria and compares to `tasks.settings.rubric_set`.
  - Uses hash mismatch as an additional signal to upsert/update `rubric_shell` steps and set `rerun`.
  - Persists updated hash map back to the task settings and removes entries for deleted criteria.
- Data model updates:
  - Added `RubricSet map[string]string` to `pkg/models/tasks.go/TaskSettings`.
  - Kept legacy `Rubrics` map for backward compatibility.
- Utility updates:
  - Added `CalcRubricSetCriterionHash(score, rubric, required, command, counter string)` in `pkg/models/utilities.go`.

### Docker Build Platform Handling
- Moved platform selection to task-level setting `tasks.settings.platform` (e.g., `linux/amd64`).
- `docker_build` now reads platform from the task and injects `--platform` automatically when not present.
- Temporary migration logic: on processing a `docker_build` step, any `--platform` flags in `step.settings.docker_build.parameters` are removed and persisted to rely solely on task-level setting.
- Files updated: `pkg/models/tasks.go`, `pkg/models/docker.go`, `internal/process_docker_build.go`, `internal/execute_docker_build.go`, `internal/tasks.go`, `help/help.go`.

### Docker Extract Volume: Conditional Rsync (2025-08-26)
- Updated `internal/steps.go/ProcessDockerExtractVolumeStep` so the helper container + rsync runs only when:
  - The target Docker volume does not exist (newly created this run), or
  - The step is invoked with `--force` (i.e., `settings.docker_extract_volume.force=true`).
- Implementation details:
  - Check existence with `docker volume inspect <name>`; set `shouldSync=true` on create or when forced.
  - Wrap container start + `rsync` operations in `if shouldSync { ... }`.
  - Continue to update task settings (volume name) and file hashes regardless of sync.
- Build verified with `go build ./...`.

## Current Refactoring: Path Handling
Canonicalize on tasks.local_path and remove tasks.base_path everywhere.
All SQL now selects `COALESCE(t.local_path, '') AS base_path` for backward-compatible struct binding.
Dropped base_path column via migration `0010_remove_base_path_column.up.sql` with a down migration to re-add if necessary.
Updated step processors and plugins to use local_path-only filters and logic.
Adjusted error messages and validations to reference local_path only.
Kept struct field names (e.g., StepExec.BasePath) but sourced from local_path to avoid large refactors.

## Web UI & API (2025-08-15)

### Backend API Endpoints Added
- GET `/tasks/:id/report` — returns structured JSON from `internal/report.go/ReportTaskJSON()` for task detail view.
- GET `/tasks/:id/settings` — fetch task settings JSON.
- PUT `/tasks/:id/settings` — update task settings JSON.
- GET `/steps/:id/settings` — fetch step settings JSON.
- PUT `/steps/:id/settings` — update step settings JSON.

Implemented in `internal/migrate.go`. Build verified with `go build ./...`.

### Report JSON Structure
- `TaskReport { task_id, task_name, roots: ReportNode[], output_sizes }`
- `ReportNode { id, title, settings (raw JSON string), results (nullable string), children }`
- Dependencies parsed from `depends_on` both top-level and nested settings.
- Results read from `steps.results` column only (aligns with recent migration).

### Frontend Next Steps
- Add Task Detail page to fetch `/tasks/:id/report` and render a dependency tree.
- Link rows in `frontend/src/pages/Report.jsx` to the Task Detail page.
- Add forms to edit task and step settings via the new endpoints.
- Wire WebSocket updates into the detail view for live refresh.

### Notes
- CORS allows localhost origins; update as needed for deployment.
- Keep API error logging in `tmp/api-errors.log` for debugging.

## MHTML Rubrics Removal (2025-08-16)

- Removed all support for MHTML-based rubric imports.
- Deleted `MHTMLFile` field from `pkg/models/rubrics_import_helpers.go/RubricsImportConfig`.
- Removed `ProcessRubricsMHTML` implementation in `pkg/models/rubrics_import.go` (left minimal stub comment).
- Cleaned `internal/process_rubrics_import.go` to drop the MHTML branch; now only JSON/Markdown paths remain.
- Updated README `rubrics_import` docs to use `json_file`/`md_file` and explicitly state MHTML is removed.
- Skipped MHTML test: `internal/process_rubrics_import_test.go` now calls `t.Skip(...)` and no longer creates `rubrics.mhtml`.
- Verified with `go build ./...` successfully; `go test ./...` fails only on unrelated dynamic_lab and docker_volume_pool tests.

Follow-ups:
- Add a JSON/Markdown-based test for `rubrics_import` to replace the skipped MHTML test.
- Ensure any downstream steps that referenced `TASK_DATA.md` continue to work with JSON/MD inputs.

## Recent Changes (2025-08-18)

### Docker Pool Owns Container Lifecycle + Health Validation
- __Ownership__: `docker_pool` is the sole owner of container assignment and lifecycle. `rubric_shell` does not start/stop/recreate containers.
- __Stable mapping__: Preserves exact key→container mapping from `tasks.settings.containers_map` and prevents a single ID from being reused across multiple keys.
- __Reuse__: Starts stopped-but-valid containers to avoid unnecessary recreation; removes outdated containers with mismatched images.
- __Health gate__: After (re)starting, runs `git -c safe.directory=<app_folder> status` in each container. Step only succeeds if all containers pass.
- __Lock guard__: Detects `.git/index.lock` and removes it before git operations during validation and during rubric runs to prevent stale lock failures.

Files: `internal/process_docker_pool.go`

### Rubric Shell: Parallel, Read-Only Container Usage
- __Read-only__: `rubric_shell` only reads `tasks.settings.containers_map` and skips if a container is not running. No lifecycle management remains here.
- __Parallelism__: Executes assignments for original, golden, and solution containers concurrently via goroutines with proper synchronization.
- __Cleanup guards__: `runTestSequence()` and `runOriginalSequence()` include `.git/index.lock` removal guard before cleanup steps.

Files: `internal/process_rubric_shell.go`

### Rubrics Storage Unification
- __Single source of truth__: `rubrics_import` writes criterion hashes to `tasks.settings.rubric_set` only.
- __Legacy removal__: Clears legacy `tasks.settings.rubrics` to avoid duplication.

Files: `internal/process_rubrics_import.go`, `pkg/models/tasks.go`

### Docker Volume Pool: Keep-Alive and Parameter Handling Fix
- Fixed containers exiting immediately after creation in `pkg/models/docker_volume_pool.go` by correcting how the keep-alive is passed to the shell.
- `AddKeepAliveCommand()` now:
  - Detects bash entrypoint and uses `-lc "while true; do sleep 30; done"`.
  - Removes stray `--login` which conflicts with `-lc`.
  - Ensures the script is a single token and not split.
- `RunDockerCommand()` now:
  - Strips user-provided `--name` to avoid duplication with our `--name`.
  - Preserves the command string after `-c`/`-lc` during arg flattening.
  - Avoids duplicate `-d` when `detached=true`.
- Added richer logging around constructed docker run args and post-run inspect.
- Build verified with `go build ./...`; ready for re-run of step 444.

### Task Settings Reset Preservation
- Updated `internal/tasks.go/ResetTaskContainers()` to preserve `tasks.settings.docker_run_parameters` when resetting containers.
- Removed duplicate assignments that re-set `containers_map` and cleared parameters redundantly.
- Now only `assigned_containers` and `containers_map` are cleared, keeping user-defined run parameters intact.

### Recent Changes (2025-08-21)

- __Docker Volume Pool container resolution__: Replaced ad-hoc container name assignment with `resolveContainerName(base)` so solutions consistently map to `tasks.settings.containers_map` entries, with stable fallback names. Applied in both `internal/process_docker_pool.go` and `pkg/models/docker_volume_pool.go`.
- __Recreation decision logging__: Added explicit decision logs in `RunDockerVolumePoolStep()` showing `shouldRecreate` and `force` per container.
- __Force flag auto-reset__: After a successful run, `settings.docker_volume_pool.force` is reset to false and a cleanup log is emitted. Prevents unintended reruns.
- __Safer container lifecycle__: Removed unconditional `docker rm -f <name>` from `RunDockerCommand()`; containers are only removed when `ShouldRecreateContainer()` or `--force` dictates. Prevents duplicate golden/original containers and accidental churn.
- __Accurate image comparison__: `ShouldRecreateContainer()` now resolves the full expected image ID via `docker inspect {{.ID}}` when provided and compares exact IDs; if resolution fails, falls back to tag comparison. Logs clearly indicate comparison basis.

### Golden Flag Persistence (2025-08-21)
- __Runtime-only__: The `--golden` flag is injected into step configs at runtime but is now explicitly reset to false after execution so it does not persist to future runs.
- __docker_extract_volume__: After sync and hash update, we run a DB update to set `settings.docker_extract_volume.golden = false`.
- __docker_volume_pool__: When persisting updated settings, we set `settings.docker_volume_pool.golden = false` alongside resetting `force`.
- __Behavior__: Golden logic runs unconditionally when golden volume/container is missing; otherwise it runs only when `--golden` is provided.

### Next Steps
- Monitor for any recurrence of `.git/index.lock` after these guards; add auto-heal in `docker_pool` if needed.
- Complete any remaining readers to only use `tasks.settings.rubric_set` and remove dead code referencing legacy `rubrics`.
- Consider adding timeouts/cancellation for long rubric_shell runs.

## CLI Additions (2025-08-23)

- __step golden__: Added `task-sync step golden STEP_ID [--force]` to run a single `rubric_shell` step in Golden-only mode.
  - Internals: uses `internal.SetRubricRunModeForCLI("golden-only")` to restrict assignments, then calls `ProcessSpecificStep(..., force, golden=true, original=false)`.
  - Help: `help/help.go/PrintStepGoldenHelp()` and listed in `PrintStepHelp()`.
  - Purpose: Quickly validate held-out tests against the Golden container without running other solution/original paths.

## Update (2025-08-26)
- Implemented CLI  in .
- Added , wired dispatcher in .
- Ensured rubric mode via .
- Verified build success  and help entry.
- Next: run validation with a real step ID, verify DB results merge.

## Update (2025-08-26)
- Implemented CLI `step original` in `cmd/cmd.go`.
- Added `HandleStepOriginal`, wired dispatcher in `HandleStep()`.
- Ensured rubric mode via `internal.SetRubricRunModeForCLI("original-only")`.
- Verified build success (`go build ./...`) and help entry.
- Next: run validation with a real step ID and verify DB results merge.


## Update (2025-08-26)
- Implemented CLI `step original` in `cmd/cmd.go`.
- Added `HandleStepOriginal` and wired dispatcher in `HandleStep()`.
- Restricted rubric path with `internal.SetRubricRunModeForCLI("original-only")`.
- Verified `go build ./...` and help output for `step original --help`.
- Next: run against a real step ID and confirm DB results coexist with golden/solutions.
